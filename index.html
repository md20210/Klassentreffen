<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>40-jähriges Abi-Treffen vom Rats</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.42.3/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            padding-top: 40px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 900px;
            width: 100%;
            position: relative;
            animation: slideIn 0.5s ease-out;
            max-height: calc(100vh - 80px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header-sticky {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 30px 40px 20px 40px;
            border-bottom: 2px solid #e0e0e0;
            border-radius: 20px 20px 0 0;
        }

        .container-content {
            overflow-y: auto;
            padding: 40px;
            flex: 1;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .motivation {
            background: #f8f9ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 5px;
        }

        .motivation p {
            color: #444;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .success-message {
            display: none;
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .participants-count {
            text-align: center;
            color: #667eea;
            font-weight: 600;
            margin-top: 20px;
            font-size: 1.1em;
        }

        .download-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .download-button {
            background: linear-gradient(135deg, #43a047 0%, #66bb6a 100%);
            margin-top: 15px;
        }

        .download-button:hover {
            box-shadow: 0 5px 15px rgba(67, 160, 71, 0.4);
        }

        .participants-list {
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }

        .participant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9ff;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .participant-item:hover {
            background: #e8edff;
        }

        .participant-name {
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .participant-email {
            flex: 2;
            margin-left: 15px;
        }

        .participant-email input {
            padding: 8px;
            font-size: 14px;
        }

        .edit-button {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
            width: auto;
        }

        .edit-button:hover {
            background: #5568d3;
        }

        @media (max-width: 600px) {
            .header-sticky {
                padding: 20px;
            }
            .header-sticky h1 {
                font-size: 1.5em;
            }
            .header-sticky .subtitle {
                font-size: 0.9em;
            }
            .container-content {
                padding: 20px;
            }
            .participant-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .participant-email {
                width: 100%;
                margin-left: 0;
                margin-top: 10px;
            }
            .edit-button {
                margin-left: 0;
                margin-top: 10px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sticky Header -->
        <div class="header-sticky">
            <h1>40-jähriges Abi-Treffen</h1>
            <p class="subtitle">Ratsgymnasium - Lasst uns die Schulzeit feiern!</p>
        </div>

        <div class="container-content">
            <div class="motivation">
                <p><strong>Liebe Abiturientinnen und Abiturienten!</strong></p>
                <p>40 Jahre nach unserem Abitur am Ratsgymnasium ist es Zeit für ein großes Wiedersehen! Diese E-Mail-Sammlung dient der Organisation und Einladung aller Absolventinnen und Absolventen.</p>
                <p><strong>Alle Änderungen werden in einer zentralen Datenbank gespeichert!</strong> Jeder kann die E-Mail-Adressen sehen und bearbeiten.</p>
            </div>

            <form id="emailForm">
            <div class="form-group">
                <label for="name">Dein Name</label>
                <select id="name" name="name" required>
                    <option value="">Bitte wählen...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="email">Deine E-Mail-Adresse</label>
                <input type="email" id="email" name="email" placeholder="deine@email.de" required>
            </div>

            <button type="submit">E-Mail speichern / aktualisieren</button>
        </form>

        <div class="success-message" id="successMessage">
            Vielen Dank! Deine E-Mail-Adresse wurde gespeichert!
        </div>

        <div class="participants-count" id="participantsCount">
            <!-- Anzahl wird hier angezeigt -->
        </div>

        <div class="download-section">
            <h2 style="color: #667eea; margin-bottom: 15px; text-align: center;">Download</h2>
            <button class="download-button" onclick="downloadWord()">
                Liste als Word-Dokument herunterladen
            </button>
        </div>

        <div class="participants-list" id="participantsList">
            <!-- Teilnehmerliste wird hier eingefügt -->
        </div>
        </div>
    </div>

    <script>
        const names = [
            "Carsten Dobschall",
            "Michael Dütting",
            "Ansgar Ellermann",
            "Irene Etmann (jetzt: Bils)",
            "Klaus Gunnemann",
            "Stefan Hille",
            "Peter Hoppe",
            "Martina Höptner (jetzt: Hecker)",
            "Stephan Horstmann",
            "Ralf Huihsen",
            "Stephan Kappen",
            "Klaus Klöker",
            "Bernd Kottmann",
            "Klaus Loskant",
            "Sabine Lünnemann (jetzt: Vortkamp)",
            "Andreas Menke",
            "Stephan Quiel",
            "Roland Rietkoetter",
            "Olaf Saphörster",
            "Annette Schwarte",
            "Andre Sickmann",
            "Thomas Siebert",
            "Eike Silvester Wiemann",
            "Magnus Wolke",
            "Heinz Wöstmann",
            "Gernot Becker",
            "Christiane Buck (jetzt: Schmidt)",
            "Michael Dabrock",
            "Jochen Dahm",
            "Melanie Dörholt",
            "Birgit Dohmen (jetzt: Decker)",
            "Patric Droste zu Senden",
            "Roman Feil",
            "Georg Fels",
            "Andreas Golf",
            "Klaus Günther",
            "Volker Hahn",
            "Karin Harnisch",
            "Frank Kloppenburg",
            "Dirk Köwener",
            "Harald Kröger",
            "Peter Lahrkamp",
            "Bernd Lehmann",
            "Katrin Lumma",
            "Mechthild Lütke Kleimann",
            "Silke Mersmann (jetzt: Born)",
            "Dirk Neufelder",
            "Ursula Neumann",
            "Josef Niehoff",
            "Stefan Niggemeyer",
            "Gerhard Nowak",
            "Madueke Okegwo",
            "Renate Ostermeyer",
            "Bettina Otto",
            "Mechthild Rickert",
            "Axel Ritter",
            "Eva Sandhage (jetzt: Wehmeyer-Sandhage)",
            "Ralf Schupp",
            "Bettina Seidensticker",
            "Martin Sommermeyer",
            "Peter Sperling",
            "Wolfgang Spille",
            "Benedikt Sudbrock",
            "Thomas Terrahe",
            "Volker Welp",
            "Susanne Wettwer",
            "Uwe Wilme",
            "Reinhold Albrecht",
            "Peter Alt-Epping",
            "Konstanze Bader",
            "Michael Beneke",
            "Marc Böddecker",
            "Georg Bratke",
            "Carsten Brüning",
            "Andreas Döpp",
            "Jürgen Dorgeist",
            "Oliver Dütschke",
            "Dirk Eberhardt",
            "Reinhild Erling",
            "Marie-Luise Ernst (jetzt: Terrahe)",
            "Mathias Eßing",
            "Karsten Evers",
            "Christian Fischer",
            "Sabine Gädeke",
            "Veronica Gohl",
            "Anne Grewe (jetzt: Vetter)",
            "Monika Haye (jetzt: Gaedeke)",
            "Jörg Hecker",
            "Andrea Heller",
            "Ingo Hentschel",
            "Jörg Hesselink",
            "Annegret Hobbeling",
            "Markus Hock",
            "Thomas Hörnemann",
            "Bettina Horstmann",
            "Volker Hund",
            "Marcus Janotta",
            "Stephan Kehr",
            "Renate Kellers (jetzt:? Herzog)",
            "Martin Kintrup",
            "Annette Knirim",
            "Bernd Korves",
            "Michael Laermann",
            "Petra Lindner (jetzt: Hubeny-Lindner)",
            "Dominik Löer",
            "Friedrich Lührmann",
            "Arno Lutz",
            "David Lützenkirchen",
            "Henning Meißner",
            "Frank Mense",
            "Thomas Mertens",
            "Matthias Michalczyk",
            "Oliver Müllmann",
            "Anja Neumann-Wedekindt",
            "Jürgen Proch",
            "David Rehmann",
            "Katrin Richter",
            "Barbara Sauer",
            "Fabian Sauerwald",
            "Tobias Sauerwald",
            "Klaus Schaphorn",
            "Thomas Schleicher",
            "Anne Schlummer",
            "Frank Schulte",
            "Ludger Schwarte",
            "Harald Siegmund",
            "Andreas Südbeck",
            "Helmut Südmersen",
            "Wolfgang Thomas",
            "Clarus von der Horst",
            "Kai Wengler",
            "Melanie Wessels",
            "Roland Wilmes"
        ];

        // Namen zum Select hinzufügen
        const nameSelect = document.getElementById('name');
        names.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            nameSelect.appendChild(option);
        });

        // Teilnehmerliste laden und anzeigen
        async function loadParticipants() {
            try {
                const response = await fetch('https://api.dabrock.info/api/klassentreffen/participants');
                const data = await response.json();
                displayParticipants(data.participants);
                updateParticipantsCount();
            } catch (error) {
                console.error('Error loading participants:', error);
            }
        }

        // Teilnehmer anzeigen
        function displayParticipants(participants) {
            const listContainer = document.getElementById('participantsList');
            listContainer.innerHTML = '<h3 style="color: #667eea; margin-bottom: 15px;">Alle Teilnehmer</h3>';

            participants.forEach(participant => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <div class="participant-name">${participant.name}</div>
                    <div class="participant-email">
                        <input type="email"
                               id="email-${encodeURIComponent(participant.name)}"
                               value="${participant.email || ''}"
                               placeholder="email@example.de">
                    </div>
                    <button class="edit-button" onclick="updateEmail('${participant.name.replace(/'/g, "\\'")}')">
                        Speichern
                    </button>
                `;
                listContainer.appendChild(item);
            });
        }

        // E-Mail aktualisieren
        async function updateEmail(name) {
            const emailInput = document.getElementById(`email-${encodeURIComponent(name)}`);
            const email = emailInput.value;

            if (!email) {
                alert('Bitte gib eine E-Mail-Adresse ein.');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Bitte gib eine gültige E-Mail-Adresse ein.');
                return;
            }

            try {
                const response = await fetch('https://api.dabrock.info/api/klassentreffen/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name, email })
                });

                if (response.ok) {
                    alert('E-Mail-Adresse erfolgreich gespeichert!');
                    loadParticipants();
                } else {
                    alert('Fehler beim Speichern. Bitte versuche es erneut.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Fehler beim Speichern. Bitte versuche es erneut.');
            }
        }

        // Form submission
        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
            };

            try {
                const response = await fetch('https://api.dabrock.info/api/klassentreffen/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    document.getElementById('successMessage').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('successMessage').style.display = 'none';
                    }, 3000);
                    document.getElementById('emailForm').reset();
                    loadParticipants();
                } else {
                    alert('Es gab einen Fehler. Bitte versuche es erneut.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Es gab einen Fehler. Bitte versuche es erneut.');
            }
        });

        // Teilnehmerzahl aktualisieren
        async function updateParticipantsCount() {
            try {
                const response = await fetch('https://api.dabrock.info/api/klassentreffen/count');
                const data = await response.json();
                document.getElementById('participantsCount').textContent =
                    `Bereits ${data.count} Teilnehmer haben ihre E-Mail-Adresse hinterlegt!`;
            } catch (error) {
                console.error('Error fetching count:', error);
            }
        }

        // Word-Download Funktion
        async function downloadWord() {
            try {
                const response = await fetch('https://api.dabrock.info/api/klassentreffen/participants');
                const data = await response.json();

                // Erstelle eine einfache HTML-Tabelle für Word
                let content = `
                    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                    <head><meta charset='utf-8'><title>40-jähriges Abi-Treffen - Teilnehmerliste</title></head>
                    <body>
                        <h1 style="text-align: center; color: #667eea;">40-jähriges Abi-Treffen vom Ratsgymnasium</h1>
                        <h2 style="text-align: center; color: #666;">Teilnehmerliste mit E-Mail-Adressen</h2>
                        <p style="text-align: center; color: #666;">Erstellt am ${new Date().toLocaleDateString('de-DE')}</p>
                        <br>
                        <table border="1" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background-color: #667eea; color: white;">
                                    <th style="padding: 10px; text-align: left;">Nr.</th>
                                    <th style="padding: 10px; text-align: left;">Name</th>
                                    <th style="padding: 10px; text-align: left;">E-Mail-Adresse</th>
                                    <th style="padding: 10px; text-align: left;">Registriert am</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.participants.forEach((p, index) => {
                    const registeredDate = p.registered_at && p.email ?
                        new Date(p.registered_at).toLocaleDateString('de-DE') : '-';
                    content += `
                        <tr>
                            <td style="padding: 8px;">${index + 1}</td>
                            <td style="padding: 8px;">${p.name}</td>
                            <td style="padding: 8px;">${p.email || 'Noch keine E-Mail'}</td>
                            <td style="padding: 8px;">${registeredDate}</td>
                        </tr>
                    `;
                });

                content += `
                            </tbody>
                        </table>
                        <br>
                        <p style="color: #666;">Gesamtanzahl: ${data.participants.length} Personen</p>
                        <p style="color: #666;">Davon mit E-Mail: ${data.participants.filter(p => p.email).length} Personen</p>
                    </body>
                    </html>
                `;

                // Erstelle Blob und Download
                const blob = new Blob(['\ufeff', content], {
                    type: 'application/msword'
                });

                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = '40-jaehriges-Abi-Treffen-Teilnehmerliste.doc';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

            } catch (error) {
                console.error('Error downloading Word document:', error);
                alert('Fehler beim Erstellen des Downloads.');
            }
        }

        // Beim Laden die Teilnehmer laden
        loadParticipants();
    </script>
</body>
</html>
